(function(){angular.module("flipCache",[]).factory("flipCache",["$http","$q",function(a,b){var c,d,e,f,g,h,i,j,k,l;return h=console.log,f=function(a,b){return null==a&&(a={}),null==b&&(b={}),JSON.stringify({query:a,options:b})},e=function(a){return null==a&&(a={}),JSON.stringify(a)},g=function(a){return null==a&&(a={}),1===Object.keys(a).length&&"_id"===Object.keys(a)[0]},d=function(a){var b,c,e,f;if("object"!=typeof a)return a;if(null===a)return a;if(a instanceof Array)return function(){var b,c,e;for(e=[],b=0,c=a.length;c>b;b++)f=a[b],e.push(d(f));return e}();c={};for(b in a)e=a[b],e instanceof Date?(c[b]=d(e),c[b].__proto__=e.proto):c[b]=d(e);return c},j=function(c,d,e){return b(function(b,f){var g,h;return h="/api/"+c,g={},Object.keys(d).length>0&&(g.q=JSON.stringify(d)),Object.keys(e).length>0&&(g.fields=JSON.stringify(e)),a({method:"GET",url:h,params:g}).success(function(a,c,d,e){return angular.isDefined(a._status)&&"OK"===a._status&&angular.isDefined(a._items)?b(a):f(a)}).error(function(a,b,c,d){return f({_status:"ERR",_msg:"Server returned code "+b})})})},k=function(c,d){return b(function(b,e){var f;return f="/api/"+c,a({method:"POST",url:f,data:d}).success(function(a,c,d,f){return angular.isDefined(a._status)&&"OK"===a._status&&angular.isDefined(a._item)?b(a):e(a)}).error(function(a,b,c,d){return e({_status:"ERR",_msg:"Server returned code "+b})})})},l=function(c,d){return b(function(b,e){var f;return f="/api/"+c+"/"+d._id,a({method:"PUT",url:f,data:d}).success(function(a,c,d,f){return angular.isDefined(a._status)&&"OK"===a._status&&angular.isDefined(a._item)?b(a):e(a)}).error(function(a,b,c,d){return e({_status:"ERR",_msg:"Server returned code "+b})})})},i=function(c,d){return b(function(b,e){var f;return f="/api/"+c+"/"+d._id,a({method:"DELETE",url:f}).success(function(a,c,d,f){return angular.isDefined(a._status)&&"OK"===a._status?b():e(a)}).error(function(a,b,c,d){return e({_status:"ERR",_msg:"Server returned code "+b})})})},new(c=function(){function a(){this._listCache={},this._docCache={}}return a.prototype._setupCache=function(a){return a in this._listCache||(this._listCache[a]={}),a in this._docCache?void 0:this._docCache[a]={}},a.prototype._isCached=function(a,b,c,d){var h,i;return this._setupCache(a),g(b)?(h=e(d),b._id in this._docCache[a]&&this._docCache[a][b._id].valid&&h in this._docCache[a][b._id]):(i=f(b,c),h=e(d),i in this._listCache[a]&&this._listCache[a][i].valid&&this._listCache[a][i].docs.every(function(a){return a.valid&&h in a}))},a.prototype._getList=function(a,b,c,h){var i,j,k;return this._setupCache(a),g(b)?(i=e(h),[this._getDoc(a,b,h)]):(j=f(b,c),i=e(h),d(function(){var b,c,d,e;for(d=this._listCache[a][j].docs,e=[],b=0,c=d.length;c>b;b++)k=d[b],e.push(k[i]);return e}.call(this)))},a.prototype._getDoc=function(a,b,c){var f;return f=e(c),d(this._docCache[a][b._id][f])},a.prototype._cacheList=function(a,b,c,d,h){var i,j;return this._setupCache(a),g(b)?this._cacheDoc(a,h[0],d):(j=f(b,c),i=e(d),j in this._listCache[a]||(this._listCache[a][j]={}),this._listCache[a][j].valid=!0,this._listCache[a][j].docs=[],h.forEach(function(b){return function(c){return b._listCache[a][j].docs.push(b._cacheDoc(a,c,d))}}(this)))},a.prototype._cacheDoc=function(a,b,c){var d;return d=e(c),b._id in this._docCache[a]||(this._docCache[a][b._id]={}),this._docCache[a][b._id].valid=!0,this._docCache[a][b._id][d]=b,this._docCache[a][b._id]},a.prototype.invalidateDoc=function(a,b){return this._setupCache(a),b in this._docCache[a]?this._docCache[a][b].valid=!1:void 0},a.prototype.invalidateLists=function(a){var b,c,d,e;this._setupCache(a),c=this._listCache[a],d=[];for(b in c)e=c[b],d.push(e.valid=!1);return d},a.prototype.find=function(a,c,d,e){var f;return null==c&&(c={}),null==d&&(d={}),null==e&&(e={}),f=this._isCached(a,c,d,e)?b(function(a){return a()}):j(a,c,e).then(function(b){return function(f){return b._cacheList(a,c,d,e,f._items)}}(this))["catch"](function(a){throw a}),f.then(function(b){return function(){return b._getList(a,c,d,e)}}(this))},a.prototype.findOne=function(a,c,d,e){var f;return null==c&&(c={}),null==d&&(d={}),null==e&&(e={}),f=this._isCached(a,c,d,e)?b(function(a){return a()}):j(a,c,e).then(function(b){return function(f){return b._cacheList(a,c,d,e,f._items)}}(this))["catch"](function(a){throw a}),f.then(function(b){return function(){return b._getList(a,c,d,e)[0]}}(this))},a.prototype.insert=function(a,b){return this._setupCache(a),k(a,b).then(function(b){return function(c){return b._cacheDoc(a,c._item),c._item}}(this))["catch"](function(a){throw a})},a.prototype.update=function(a,b){return this._setupCache(a),l(a,b).then(function(b){return function(c){return b._cacheDoc(a,c._item),c._item}}(this))["catch"](function(a){throw a})},a.prototype.remove=function(a,b){return this._setupCache(a),i(a,b).then(function(c){return function(d){return c.invalidateDoc(a,b._id),null}}(this))["catch"](function(a){throw a})},a}())}])}).call(this),function(){angular.module("flipDoc",["flipCache"]).factory("flipDoc",["$q","flipCache",function(a,b){var c;return c=function(){function c(a,b){this._id=null,"object"==typeof a?this._extend(a):(this._collection=a,"object"==typeof b?this._extend(b):this._id=b)}return c.prototype._extend=function(a){var b,c,d;c=[];for(b in a)d=a[b],c.push(angular.isFunction(d)?void 0:this[b]=d);return c},c.prototype._clear=function(){var a,b,c;b=[];for(a in this)c=this[a],b.push(angular.isFunction(c)?void 0:this[a]=null);return b},c.prototype.$get=function(){return a(function(a){return function(c,d){return b.findOne(a._collection,{_id:a._id}).then(function(b){return a._extend(b),c(a)})["catch"](function(a){return d(a)})}}(this))},c.prototype.$save=function(){return a(function(a){return function(c,d){return a._id?b.update(a._collection,a).then(function(b){return a._extend(b),c(a)})["catch"](function(a){return d(a)}):b.insert(a._collection,a).then(function(b){return a._extend(b),c(a)})["catch"](function(a){return d(a)})}}(this))},c.prototype.$delete=function(){return a(function(a){return function(c,d){return b.remove(a._collection,a).then(function(b){return a._clear(),c(a)})["catch"](function(a){return d(a)})}}(this))},c}(),function(a,b){return new c(a,b)}}])}.call(this),function(){angular.module("flipList",["flipCache","flipDoc"]).factory("flipList",["$q","flipCache","flipDoc",function(a,b,c){return function(d){var e;return e=[],e.collection=d.collection,e.filter=d.filter||{},e.options=d.options||{},e.fields=d.fields||{},e.$get=function(){return a(function(a,d){return b.find(e.collection,e.filter,e.options,e.fields).then(function(b){var d,f,g;for(e.splice(0,e.length),d=0,f=b.length;f>d;d++)g=b[d],e.push(c(e.collection,g));return a(this)})["catch"](function(a){return d(a)})})},e}}])}.call(this);